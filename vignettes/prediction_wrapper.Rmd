---
title: "Prediction Wrapper"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Prediction Wrapper}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Prediction Wrapper Support

The start of using any machine learning algorithm with the `Distillery` package 
is the prediction wrapper, which wraps any machine learning algorithm and converts 
it to a `Predictor` class object. The `Predictor` wrapper requires a single 
set of predictions at the end, and therefore users may need to provide their 
own prediction functions based on the original algorithm they hope to wrap. This 
page provides two key examples: predicting probabilities of being in a specific class for 
a categorical feature, and specifying one's own prediction function.

### Predictor Wrapper With Categorical Features

To use `Distillery` with categorical feature prediction, the user specifies the prediction task 
as `task = "classification`, chooses a specific value of the categorical feature 
with the `class` argument, and provide the `type` argument for the prediction. 
Below, we demonstrate this with an example of using a multinomial 
logstic regression model to predict the likelihood of a iris observation 
being of the "setosa" species.

```{r, include=FALSE, echo = FALSE, results='hide'}
# Load the required packages
library(Distillery)
library(Rforestry)
library(ggplot2)
library(dplyr)
```

```{r, echo = TRUE}
# Load the required packages
library(Distillery)
library(nnet)

# Load in data 
data("iris")
set.seed(491)
data <- iris

# Train a mutinomial logistic regression model on the data set
multilog <- multinom(Species ~., data = data)
head(predict(multilog, type = "probs"))

# Create a predictor wrapper for the model (specify task, class, type)
setosa_predictor <- Predictor$new(model = multilog,
                                  data=data,
                                  y="Species",
                                  task = "classification",
                                  class = "setosa",
                                  type = "probs")

# Predictions returned for setosa probabilities
head(predict(setosa_predictor, iris))
```

As desired, we see that the final predictions are the predicted probabiltiies of 
an observation being a "setosa" type iris.

### Specifying User-Inputted Prediction Functiobs

More generally, to get a single vector or column of predictions, we may need to 
specify the prediction function itself. In this case, the user can pass their own 
prediction function with the `predict_func` argument when intialiizing the `Predictor` 
object. We provide an example of this with the BART (Bayesian Additive Regression Tree) 
algorithm from package `dbarts`.

```{r}
library(dbarts)
cat.index <- which(names(data) == "Species") # BART requires numerical features

# create a BART model
bart.model <- bart(x.train = data[, -c(1, cat.index)],
                   y.train = data[, 1],
                   keeptrees = T,
                   ndpost = 500,
                   verbose = F)

# default predictions result in multiple columns
predict(bart.model, data[, -c(1, cat.index)])[1:5, 1:5]

# create user-specified function
predict_bart <- function(object, newdata){
  return(colMeans(predict(object, newdata)))
}

# initialize Predictor object for BART
bart_predictor <- Predictor$new(model = bart.model,
                                data = data[, -cat.index],
                                predict.func = predict_bart,
                                y = "Sepal.Length",
                                task = "regression")

# predict with the Predictor object
predict(bart_predictor, data[, -c(1, cat.index)])[1:5, ]
```

As desired, the user-specified prediction method input results in predictions 
of a single vector or one-column dataframe. For further details, please refer to 
the documentation for the `Predictor` class in the "References" section.

