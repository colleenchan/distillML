---
title: "ICE Clustering"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ICE Clustering}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Clustering ICE Plots

Often the PDP plots do not tell the whole story of the model fit. 
The individual conditional expectation plots can let us examine the predictions of the
model at a more granular level.
We note that the PDP plots are the average over the training data of the ICE plots.


```{r, include=FALSE, echo = FALSE, results='hide'}
# Load the required packages
library(Distillery)
library(Rforestry)
```

```{r, echo = TRUE}
# Load the required packages
library(Distillery)
library(Rforestry)

# Load in data 
data("iris")
set.seed(491)
data <- iris

# Train a random forest on the data set
forest <- forestry(x=data[,-1],
                   y=data[,1])

# Create a predictor wrapper for the forest
forest_predictor <- Predictor$new(model = forest,
                                  data=data,
                                  y="Sepal.Length",
                                  task = "regression")

# Initialize an interpreter
forest_interpret <- Interpreter$new(predictor = forest_predictor)
```

Given an `Interpreter` object, we can create ICE plots using the `plot()` method 
and setting `method="ice"`.
If one also wants to include the PDP plot, one can use `method="pdp+ice"`.

```{r, echo=TRUE}
ice_plots <-  plot(forest_interpret, method = "ice", features = "Sepal.Width")
plot(ice_plots$Sepal.Width)
```

## Clustering the ICE Plots

The ICE plots can show the heterogeneity of the model predictions, so we offer the option to 
cluster the ICE lines using unsupervised learning.
In order to create clusters, one must set the desired number of clusters with the `clusters` argument.

```{r, echo=TRUE}
ice_plots <-  plot(forest_interpret, method = "ice", features = "Sepal.Width", clusters = 4)
plot(ice_plots$Sepal.Width)
```

# Clustering Based on Gradients

We can cluster the ICE lines based on either their values, setting `clusterType = "preds"` or by their
gradient, setting `clusterType = "gradient"`.

```{r, echo=TRUE}
ice_plots <-  plot(forest_interpret, method = "ice", features = "Sepal.Width", clusters = 4, clusterType = "gradient")
plot(ice_plots$Sepal.Width)
```
